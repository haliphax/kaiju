define(["lib/jquery","lib/jquery-ui","lib/knockout"],function(e,t,n){var r={client:null,fn:{},auctions:n.observableArray(),auction:{applied:!1,price:n.observable(),items:n.observableArray(),params:n.observableArray()},bid:{applied:!1,auction:null,bid:n.observableArray(),items:n.observableArray(),params:n.observableArray()},my:{auctions:{applied:!1,auctions:n.observableArray()},bids:{applied:!1,bids:n.observableArray()},offers:{applied:!1,auction:null,bids:n.observableArray()}}};return r.fn.auction_list=function(){r.client.ajax({url:"client/action/building/auction_list",success:function(t){r.auctions(t.auctions),delete t.auctions,e("#auction_list").dialog("open"),r.client.status_bind(t)}})},r.fn.auction_my_bids=function(){r.client.ajax({url:"client/action/building/auction_my_bids",success:function(t){r.my.bids.bids(t.bids),delete t.bids,r.my.bids.applied||(r.my.bids.applied=!0,n.applyBindings(r,e("#mybids_list")[0])),e("#mybids_list").dialog("open"),r.client.status_bind(t)}})},r.fn.auction_my_auctions=function(){r.client.ajax({url:"client/action/building/auction_my_auctions",success:function(t){r.my.auctions.auctions(t.auctions),delete t.auctions,r.my.auctions.applied||(r.my.auctions.applied=!0,n.applyBindings(r,e("#myauctions_list")[0])),e("#myauctions_list").dialog("open"),r.client.status_bind(t)}})},r.fn.auction_auction=function(){r.auction.price(""),r.auction.items([]),r.client.ajax({url:"client/actparams/building/auction_auction",success:function(t){for(var i in t.params){t.params[i].opt=t.params[i].num,t.params[i].opts=[];for(var s=1;s<=t.params[i].num;t.params[i].opts.push(s++));}r.auction.params(t.params),r.auction.params.sort(r.client.item_sort),r.auction.applied||(r.auction.applied=!0,n.applyBindings(r,e("#auction_auction")[0])),e("#auction_auction").dialog("open")}})},r.fn.auction_auction_add=function(){var t=this,n=r.auction.items(),i=r.auction.params();for(var s=0;s<i.length;s++)if(i[s].instance==t.instance){var u=!0;if(t.opt>0&&t.opt<t.num){var a=r.auction.params()[s];t=e.extend({},i[s]),a.num-=t.opt,a.opts=[];for(var f=1;f<=a.num;a.opts.push(f++));a.opt=a.opts.length,r.auction.params.splice(s,1),r.auction.params.push(a),t.num=t.opt}else r.auction.params.splice(s,1);for(var f=0;f<n.length;f++)if(n[f].instance==t.instance){var a=r.auction.items()[f];u=!1,a.num+=t.opt,r.auction.items.splice(f,1),r.auction.items.push(a);break}u&&r.auction.items.push(t);break}r.auction.items.sort(r.client.item_sort),r.auction.params.sort(r.client.item_sort)},r.fn.auction_auction_remove=function(){var e=this,t=r.auction.items(),n=r.auction.params();for(var i=0;i<t.length;i++)if(t[i].instance==e.instance){var s=!0;r.auction.items.splice(i,1);for(var u=0;u<n.length;u++)if(n[u].instance==e.instance){var a=r.auction.params()[u];s=!1,a.num+=e.num,a.opts=[];for(var f=1;f<=a.num;a.opts.push(f++));a.opt=a.opts.length,r.auction.params.splice(u,1),r.auction.params.push(a);break}s&&r.auction.params.push(e);break}r.auction.items.sort(r.client.item_sort),r.auction.params.sort(r.client.item_sort)},r.fn.auction_auction_submit=function(){var t=[];for(var n=0;n<r.auction.items().length;n++){var i=r.auction.items()[n];t.push(i.instance+"_"+i.num)}r.client.ajax({url:"client/action/building/auction_auction/"+t.join("/"),type:"POST",data:{price:this.price()},success:function(t){e("#auction_auction").dialog("close"),r.client.status_bind(t),r.fn.auction_my_auctions()}})},r.fn.auction_bids=function(){var t=this.auction;r.client.ajax({url:"client/action/building/auction_auction_bids/"+t,success:function(i){r.my.offers.bids(i.bids),r.my.offers.auction=t,delete i.bids,r.my.offers.applied||(r.my.offers.applied=!0,n.applyBindings(r,e("#offers_list")[0])),e("#offers_list").dialog("open"),r.client.status_bind(i)}})},r.fn.auction_bid_accept=function(){if(!confirm("Are you sure you wish to accept this bid?"))return;r.client.ajax({url:"client/action/building/auction_auction_accept/"+r.my.offers.auction+"/"+this.actor,success:function(t){r.client.status_bind(t),e("#offers_list").dialog("close"),r.fn.auction_my_auctions()}})},r.fn.auction_cancel=function(){if(!confirm("Are you sure you wish to cancel this auction?"))return;r.client.ajax({url:"client/action/building/auction_auction_cancel/"+this.auction,success:function(e){r.client.status_bind(e),r.fn.auction_my_auctions()}})},r.fn.auction_bid=function(){r.bid.auction=this.auction,r.bid.items(this.items),r.bid.bid([]),r.client.ajax({url:"client/actparams/building/auction_bid",success:function(t){for(var i in t.params){t.params[i].opt=t.params[i].num,t.params[i].opts=[];for(var s=1;s<=t.params[i].num;t.params[i].opts.push(s++));}r.bid.params(t.params),r.bid.applied||(n.applyBindings(r,e("#auction_bid")[0]),r.bid.applied=!0),e("#auction_bid").dialog("open")}})},r.fn.auction_bid_cancel=function(){if(!confirm("Are you sure you wish to cancel this bid?"))return;r.client.ajax({url:"client/action/building/auction_bid_cancel/"+this.auction,success:function(e){r.client.status_bind(e),r.fn.auction_list(),r.fn.auction_my_bids()}})},r.fn.auction_bid_add=function(){var t=this,n=r.bid.bid(),i=r.bid.params();for(var s=0;s<i.length;s++)if(i[s].instance==t.instance){var u=!0;if(t.opt>0&&t.opt<t.num){var a=r.bid.params()[s];t=e.extend({},i[s]),a.num-=t.opt,a.opts=[];for(var f=1;f<=a.num;a.opts.push(f++));a.opt=a.opts.length,r.bid.params.splice(s,1),r.bid.params.push(a),t.num=t.opt}else r.bid.params.splice(s,1);for(var f=0;f<n.length;f++)if(n[f].instance==t.instance){var a=r.bid.bid()[f];u=!1,a.num+=t.opt,r.bid.bid.splice(f,1),r.bid.bid.push(a);break}u&&r.bid.bid.push(t);break}r.bid.bid.sort(r.client.item_sort),r.bid.params.sort(r.client.item_sort)},r.fn.auction_bid_remove=function(){var e=this,t=r.bid.bid(),n=r.bid.params();for(var i=0;i<t.length;i++)if(t[i].instance==e.instance){var s=!0;r.bid.bid.splice(i,1);for(var u=0;u<n.length;u++)if(n[u].instance==e.instance){var a=r.bid.params()[u];s=!1,a.num+=e.num,a.opts=[];for(var f=1;f<=a.num;a.opts.push(f++));a.opt=a.opts.length,r.bid.params.splice(u,1),r.bid.params.push(a);break}s&&r.bid.params.push(e);break}r.bid.bid.sort(r.client.item_sort),r.bid.params.sort(r.client.item_sort)},r.fn.auction_bid_submit=function(){var t=[],n="";for(var i=0;i<r.bid.bid().length;i++){var s=r.bid.bid()[i];t.push(s.instance+"_"+s.num)}n="client/action/building/auction_bid/"+r.bid.auction+"/"+t.join("/"),r.client.ajax({url:n,success:function(t){r.client.status_bind(t),e("#auction_bid").dialog("close"),r.fn.auction_list()}})},{fire:function(t,i,s){s.action_loadview(null,"building","auctions",function(t){r.client=t,n.applyBindings(r,e("#auction_list")[0])},function(e){r.fn.auction_list()})}}});